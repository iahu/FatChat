<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>FatChat在线聊天</title>
	<link rel="stylesheet" href="/prd/css/im.css">
</head>
<body>
	<div class="container" id="im">
		<im-main v-on:show-modal="showModal" v-on:event-from-child="eventFromChild"></im-main>
		<im-dialog maxsize="100"></im-dialog>
		<im-modal :arg="modalData"></im-modal>
	</div>


	<script type="text/x-template" id="main-tpl">
		<div class="main-wrapper" v-if="show_main" transition="fade">
			<div class="main">
				<div class="top-bar">
					<div class="inner clearfix">
						<div class="avatar-wrapper">
							<img v-if="userInfo.avatar" :src="'/img/avatar/'+userInfo.avatar" alt="{{userInfo.nickname}}" width="64" height="64">
						</div>
						<p class="name-info">{{userInfo.nickname}}</p>
						<b class="vender">FatChat</b>
					</div>

					<div class="addfriends-bar" @click="dispatchChildEvent('showModal', {id: 'addfriends-modal', title: '添加好友', modalBody: 'searchfriends'})">
						<i class="icon add"></i><a href="javascript:;" data-action="showModal" data-arg="addfriends, 添加好友">查找并添加好友</a>
					</div>
				</div>
				<div class="menu">
					<ul class="menu-list">
						<li @click="toggleMenu('session')" class="menu-item" :class="{active: current_menu === 'session'}"><button class="menu-bar">会话</button></li>
						<li @click="toggleMenu('friends')" class="menu-item" :class="{active: current_menu === 'friends'}"><button class="menu-bar">好友</button></li>
						<li @click="toggleMenu('setting')" class="menu-item" :class="{active: current_menu === 'setting'}"><button class="menu-bar">设置</button></li>
					</ul>
				</div>
				<div class="main-body">
					<div class="panel-group">
						<div class="panel-body session" v-show="current_menu === 'session'" transition="slideInLeft">
							<div class="panel-inner webkitscrollbar" @click="toggleClass('-1', 'sessions')">
								<!-- 历史会话列表 -->
								<ul class="session-list">
									<template v-if="lastMsgList.length" v-for="s in lastMsgList">
										<li class="clearfix" :class="{active: sessionsActiveID == $index}">
											<a href="javascript:;" class="list-link" @click.stop="toggleClass($index, 'sessions')"  @dblclick="openMsgDialog(s)">
												<span class="avatar"><img :src="'/img/avatar/'+s.avatar" alt="{{s.nickname}}"></span>
												<div class="text">
													<div>
														<span class="title">{{s.nickname}}</span>
														<span class="ts">{{s.createtime | getDateString}}</span>
													</div>
													<span class="body">
														{{s.body}}
														<span class="unread-count" v-show="s.unreadCount">{{s.unreadCount}}</span>
													</span>
												</div>
											</a>
										</li>
									</template>

									<li v-if="lastMsgList.length==0" class="empty-tip"><span class="title">暂无历史会话~</span></li>
								</ul>
							</div>
						</div>

						<div class="panel-body friends" v-show="current_menu === 'friends'" transition="slideInLeft">
							<div class="panel-inner webkitscrollbar" @click="toggleClass('-1', 'friends')">
								<ul class="friends-list">
									<!-- Unknow Friends -->
									<template v-for="friend in unknowFriends">
										<li class="clearfix add-request">
											<div class="list-link" @click.stop="toggleClass($index, 'friends')" :class="{active: friendsActiveID == $index}">
												<span class="avatar"><img :src="'/img/avatar/'+friend.avatar" alt="{{friend.nickname}}"></span>
												<div class="text">
													<div class="title">
														<span class="name">{{friend.nickname}}</span> 请求加你好友
													</div>
													<div class="action-bar">
														<button class="accept" @click="processAddRequest('accept', friend)">同意</button>
														<button class="reject" @click="processAddRequest('reject', friend)">拒绝</button>
													</div>
												</div>
											</div>
										</li>
									</template>

									<!-- old Friends -->
									<template v-for="friend in friends">
										<li class="clearfix">
											<a href="javascript:;" class="list-link" @click.stop="toggleClass($index, 'friends')" @dblclick="openMsgDialog(friend)" :class="{active: friendsActiveID == $index}">
												<span class="avatar"><img :src="'/img/avatar/'+friend.avatar" alt="{{friend.nickname}}"></span>
												<div class="text">
													<span class="title">{{friend.nickname}}</span>
												</div>
											</a>
										</li>
									</template>
									<li v-if="friends.length === 0" class="empty-tip"><span class="title">你还没有好友，快去添加好友吧</span></li>
								</ul>
							</div>
						</div>

						<div class="panel-body setting" v-show="current_menu === 'setting'" transition="slideInLeft">
							<div class="panel-inner webkitscrollbar list-panel">
								<ul class="list-group">
									<li class="list-item">
										<a href="#setting/nickname"  data-action="setting.nickname" class="list-link">
											<span class="list-title">昵称</span>
											<span class="list-detail">{{userInfo.nickname}}</span>
										</a>
									</li>
									<li class="list-item">
										<a href="#setting/email" data-action="setting.email" class="list-link">
											<span class="list-title">帐号(邮箱)</span>
											<span class="list-detail">{{userInfo.email}}</span>
										</a>
									</li>
									<li class="list-item">
										<a href="#setting/gender" class="list-link" data-action="gender">
											<span class="list-title">性别</span>
											<span class="list-detail">{{userInfo.gender | genderFilter}}</span>
										</a>
									</li>
								</ul>

								<ul class="list-group">
									<li class="list-item">
										<a href="#setting/about" class="list-link" data-action="about">
											<span class="list-title">关于</span>
										</a>
									</li>
								</ul>

								<ul class="list-group">
									<li class="list-item">
										<a href="#setting/quit" class="list-link" @click="quit">
											<span class="list-title">退出</span>
										</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</script>
	<script type="text/x-teplate" id="im-tpl">
		<div class="im-wrapper" v-show="visibility">
			<div class="im">
				<div class="im-top-bar clearfix">
					<span class="avatar fl-l"><img v-if="toUser.avatar" :src="'/img/avatar/' + toUser.avatar" alt="{{toUser.nickname}}"></span>
					<h5 class="im-hd fl-l">{{toUser.nickname}}</h5>
					<button class="closer btn-plaint fl-r" @click="hide">&times;</button>
				</div>
				
				<div class="im-bd">
					<div class="im-bd-left">
						<div class="im-msg-list-box webkitscrollbar" id="ps">
							<ul class="im-msg-list clearfix" v-if="msgList.length">
								<li class="top-tips" v-if="msgList.length >= maxsize-1">
									<span class="tip-body">默认最多显示{{maxsize}}条历史消息</span>
								</li>
								<li class="im-msg clearfix" v-for="msg in msgList" :class="msg.from | msgTypeFilter">
									<!-- msg from user -->
									<template v-if="msg.from === fromUser.id">
										<div class="im-msg-info">
											<span class="im-msg-title">{{fromUser.nickname}}</span> <span class="im-msg-ts">{{msg.createtime | getTimeString}}</span>
										</div>
										<div class="im-msg-content">
											<div class="avatar">
												<img :src="'img/avatar/'+ fromUser.avatar" alt="{{fromUser.nickname}}">
											</div>
											<p class="im-msg-bd">{{msg.body}}</p>
										</div>
									</template>
									<template v-else>
										<div class="im-msg-info">
											<span class="im-msg-title">{{toUser.nickname}}</span> <span class="im-msg-ts">{{msg.createtime | getTimeString}}</span>
										</div>
										<div class="im-msg-content">
											<div class="avatar">
												<img :src="'img/avatar/'+ toUser.avatar" alt="{{toUser.nickname}}">
											</div>
											<p class="im-msg-bd">{{msg.body}}</p>
										</div>
									</template>
								</li>
							</ul>
						</div>
				
						<div class="im-input-wrapper">
							<div class="im-input-toolbar">
								<button class="im-tb emoji btn-plaint">表情</button>
								<button class="im-tb photo btn-plaint">图片</button>
							</div>
				
							<div class="im-input-box">
								<div class="im-input-outter">
									<textarea class="im-input" id="im-input" autofocus="true" maxlength="200" v-model="msg" @keydown.enter.prevent="send"></textarea>
								</div>
								<div class="im-input-box-bar clearfix">
									<label class="set-send-key">
										<input type="checkbox" v-model="usesCtrlKey"> 按
										<template v-if="!usesCtrlKey">
											<code class="keyboard">Ctrl</code> +
										</template>
										<code class="keyboard">Enter</code>
										发送
									</label>
									<button class="im-send-btn fl-r" @click="send">发送</button>
								</div>
							</div>
						</div>
					</div>
				
					<div class="im-bd-right">af</div>
				</div>
			</div>
		</div>
	</script>
	<script type="text/x-template" id="modal-tpl">
		<div class="modal" v-show="visibility" :id="id" v-on:modal-show="show">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" aria-hidden="true" @click="hide">&times;</button>
						<h4 class="modal-title">{{title}}</h4>
					</div>
					<div class="modal-body" :is="modalBody">

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default"  @click="hide">取消</button>
						<button type="button" class="btn btn-primary" @click="hide">确定</button>
					</div>
				</div>
			</div>
		</div>
	</script>
	<script type="text/x-template" id="searchfriends-tpl">
		<form action="#" id="addfriends-form" onsubmit="return false;" @submit='searchFriends'>
			<div class="form-group search-box clearfix">
				<input type="text" name="friends_info" id="friends_info" placeholder="输入对方邮箱或昵称来查找好友" autocomplete="no" autofocus="autofocus" v-model="friends_info">
				<button type="submit">查找</button>
			</div>
		</form>
		<div class="friends-list">
			<div v-if="friends" v-for="friend in friends" class="friend-item clearfix" :class="friend.added ? 'active' : ''">
				<img :src="'/img/avatar/'+friend.avatar" alt="{{friend.nickname}}">
				<div class="info">
					<p>
						<span class="nickname">{{friend.nickname}}</span>
					</p>
					<p>
						<span class="gender">{{friend.gender | genderFilter}}</span>
						<button class="add btn" @click="addFriends(friend.id)" :disabled="friend.added">加为好友</button>
					</p>
				</div>
			</div>
			<span v-if="friends && friends.length === 0">没有找到相关用户</span>
		</div>
	</script>
	<script src="/js/im.js"></script>
</body>
</html>